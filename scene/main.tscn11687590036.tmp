[gd_scene load_steps=9 format=3 uid="uid://iqyu0a64eqma"]

[ext_resource type="Texture2D" uid="uid://bgebm8uu2fy2k" path="res://image/frame0.png" id="1_of57s"]
[ext_resource type="Script" uid="uid://bg812xgumqfpr" path="res://script/mgr_asset_loader.gd" id="2_b5f6u"]
[ext_resource type="Script" uid="uid://dbysro7cxr80m" path="res://script/mgr_input.gd" id="3_tqoya"]
[ext_resource type="Script" uid="uid://be6kcis0epfed" path="res://script/mgr_tilemap.gd" id="4_k65ib"]
[ext_resource type="Texture2D" uid="uid://kopva3fh2fh6" path="res://image/rect.png" id="7_hybxs"]
[ext_resource type="Script" uid="uid://cfpdog32b0qya" path="res://script/mgr_camera.gd" id="8_v2gmf"]

[sub_resource type="TileSet" id="TileSet_4j5ol"]
tile_shape = 1
tile_layout = 4
tile_size = Vector2i(32, 16)

[sub_resource type="GDScript" id="GDScript_p1hux"]
script/source = "extends Node2D

signal sgl_ui_card_selected(sid:int, card_count:int)

@onready var cursor_normal: Texture2D = preload(\"res://image/cursor_normal.png\")
@onready var cursor_pan: Texture2D = preload(\"res://image/cursor_pan.png\")
@onready var cursor : Sprite2D = $Cursor
@onready var wtml : TileMapLayer = $\"../Tilemap/WorldTileMapLayer\"
@onready var grid_container: GridContainer = $\"../../CanvasLayer/Panel/ScrollContainer/GridContainer\"


var icon_dic : Dictionary = {}
var selected_asset : int = -1
var all_card : Array[Control] = []


func _enter_tree() -> void:
	connect_tile_asset_loader()

# Called when the node enters the scene tree for the first time.
func _ready() -> void:
	change_cursor()
	
	if icon_dic.size() > 0:
		handle_icon_dic()

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(_delta: float) -> void:
	update_cursor_pos()
	
func change_cursor() -> void:
	if cursor_normal and cursor_pan:
		var hotspot = Vector2(cursor_normal.get_size() / 2)
		Input.set_custom_mouse_cursor(cursor_normal, Input.CURSOR_ARROW, hotspot)

func update_cursor_pos() -> void:
	var mp = get_global_mouse_position()
	var cp = wtml.local_to_map(mp)
	mp = wtml.map_to_local(cp)
	cursor.position = mp

func connect_tile_asset_loader() -> void:
	var mgr_asset_loader = $\"../AssetLoader\"
	if not mgr_asset_loader:
		printerr(\"错误：找不到AssetLoader节点！请检查路径是否正确\")
		return
	## 连接信号
	mgr_asset_loader.connect(\"sgl_loaded_source_icon\",on_load_source_icon)

func on_load_source_icon(dic:Dictionary):
	#确定接收到dic数据
	if dic.size() <= 0:
		printerr(\"dic 数据为空\")
		return
	icon_dic = dic
	
func handle_icon_dic() -> void:
	clear_chiildren(grid_container)
	all_card.clear()

	var card_scene: PackedScene = load(\"res://scene/card_single_set.tscn\")
	
	for path in icon_dic:
		var sid:int = int(path.get_file().get_basename())
		var icon_instance:Texture2D = icon_dic[path]
		# 加载卡片场景（替换为你的卡片场景路径）
		var card = card_scene.instantiate()
		# 给卡片设置参数
		card.sid = sid
		## 设置预览图（TileSet 用第一个瓦片的纹理作为预览）
		card.icon_texture = icon_instance
		
		## 连接卡片的选中信号
		card.connect(\"sgl_card_selected\", on_card_selected)
		
		grid_container.add_child(card)
		all_card.append(card)

# 卡片被点击选中时触发
func on_card_selected(sid:int) -> void:
	# 1. 取消所有卡片的选中状态
	for card in all_card:
		card.deselect_card()
	
	# 2. 记录当前选中的资源
	selected_asset = sid
	sgl_ui_card_selected.emit(selected_asset, all_card.size())
	#print(\"选中资源：\", asset_path.get_file().get_basename())
	

# 外部获取当前选中资源的接口
func get_selected_asset() -> int:
	return selected_asset
	

func clear_chiildren(node : Node) -> void:
	for i in node.get_child_count():
		var c = node.get_child(0)
		node.remove_child(c)
		node.queue_free()
"

[node name="World" type="Node2D"]

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="Panel" type="Panel" parent="CanvasLayer"]
self_modulate = Color(1, 1, 1, 0)
anchors_preset = 11
anchor_left = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -284.0
offset_top = 10.0
offset_right = -10.0
offset_bottom = -897.0
grow_horizontal = 0
grow_vertical = 2

[node name="Frame" type="NinePatchRect" parent="CanvasLayer/Panel"]
self_modulate = Color(1, 1, 1, 0.68235296)
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
texture = ExtResource("1_of57s")
patch_margin_left = 3
patch_margin_top = 3
patch_margin_right = 3
patch_margin_bottom = 3

[node name="ScrollContainer" type="ScrollContainer" parent="CanvasLayer/Panel"]
custom_minimum_size = Vector2(20, 20)
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 3.999939
offset_top = 4.0
offset_right = 10.000061
offset_bottom = 4.0
grow_horizontal = 2
grow_vertical = 2
scale = Vector2(0.95, 0.95)

[node name="GridContainer" type="GridContainer" parent="CanvasLayer/Panel/ScrollContainer"]
layout_mode = 2
mouse_filter = 0
theme_override_constants/h_separation = 6
theme_override_constants/v_separation = 6
columns = 4

[node name="ColorPickerButton" type="ColorPickerButton" parent="CanvasLayer/Panel"]
layout_mode = 0
offset_left = -32.0
offset_bottom = 32.0
color = Color(0.5, 0.5, 0.5, 1)

[node name="Manager" type="Node" parent="."]

[node name="AssetLoader" type="Node2D" parent="Manager"]
script = ExtResource("2_b5f6u")

[node name="Input" type="Node2D" parent="Manager"]
script = ExtResource("3_tqoya")

[node name="Tilemap" type="Node2D" parent="Manager"]
script = ExtResource("4_k65ib")

[node name="WorldTileMapLayer" type="TileMapLayer" parent="Manager/Tilemap"]
y_sort_enabled = true
tile_set = SubResource("TileSet_4j5ol")

[node name="UI" type="Node2D" parent="Manager"]
script = SubResource("GDScript_p1hux")

[node name="Cursor" type="Sprite2D" parent="Manager/UI"]
texture = ExtResource("7_hybxs")

[node name="Camera" type="Node2D" parent="Manager"]
script = ExtResource("8_v2gmf")

[node name="Camera2D" type="Camera2D" parent="Manager/Camera"]
position = Vector2(960, 540)
zoom = Vector2(3, 3)

[node name="Origin" type="Sprite2D" parent="."]
visible = false
self_modulate = Color(1, 1, 1, 0.09411765)
position = Vector2(960, 543)
texture = ExtResource("7_hybxs")

[node name="Origin2" type="Sprite2D" parent="."]
visible = false
self_modulate = Color(1, 1, 1, 0.09411765)
position = Vector2(944, 543)
texture = ExtResource("7_hybxs")

[node name="Origin4" type="Sprite2D" parent="."]
visible = false
self_modulate = Color(1, 1, 1, 0.09411765)
position = Vector2(976, 543)
texture = ExtResource("7_hybxs")

[node name="Origin5" type="Sprite2D" parent="."]
visible = false
self_modulate = Color(1, 1, 1, 0.09411765)
position = Vector2(960, 551)
texture = ExtResource("7_hybxs")

[node name="Origin6" type="Sprite2D" parent="."]
visible = false
self_modulate = Color(1, 1, 1, 0.09411765)
position = Vector2(976, 559)
texture = ExtResource("7_hybxs")

[node name="Origin7" type="Sprite2D" parent="."]
visible = false
self_modulate = Color(1, 1, 1, 0.09411765)
position = Vector2(944, 559)
texture = ExtResource("7_hybxs")
